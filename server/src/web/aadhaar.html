<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Aadhaar Offline Verifier</title>
  <style>
    body{font-family:system-ui,sans-serif;max-width:800px;margin:2rem auto;padding:1rem;line-height:1.6}
    .container{background:#f8f9fa;padding:2rem;border-radius:8px;margin:1rem 0}
    .form-group{margin:1rem 0}
    label{display:block;font-weight:600;margin-bottom:0.5rem}
    input,textarea{width:100%;padding:0.75rem;border:1px solid #ddd;border-radius:4px;font-size:1rem}
    button{background:#007bff;color:white;padding:0.75rem 1.5rem;border:none;border-radius:4px;cursor:pointer;font-size:1rem}
    button:hover{background:#0056b3}
    button:disabled{background:#6c757d;cursor:not-allowed}
    .result{background:#e8f5e8;border:1px solid #28a745;padding:1rem;border-radius:4px;margin:1rem 0}
    .error{background:#f8d7da;border:1px solid #dc3545;padding:1rem;border-radius:4px;margin:1rem 0}
    .field{margin:0.5rem 0;padding:0.5rem;background:white;border-radius:4px}
    .field strong{color:#495057}
    pre{background:#f8f9fa;padding:1rem;border-radius:4px;overflow-x:auto;font-size:0.9rem}
  </style>
</head>
<body>
  <h1>üîê Aadhaar Offline Verifier</h1>
  <p>Upload your Aadhaar Offline ZIP file and enter the share code to verify and extract data locally in your browser.</p>
  
  <div class="container">
    <div class="form-group">
      <label for="zipFile">Aadhaar Offline ZIP File:</label>
      <input type="file" id="zipFile" accept=".zip" />
    </div>
    
    <div class="form-group">
      <label for="shareCode">Share Code (4 digits):</label>
      <input type="text" id="shareCode" placeholder="1234" maxlength="4" pattern="[0-9]{4}" />
    </div>
    
    <button id="verifyBtn" onclick="verifyAadhaar()">üîç Verify & Extract</button>
  </div>

  <div id="results"></div>

  <!-- zip.js for password-protected ZIP handling (AES) -->
  <script src="./js/zip.min.js"></script>
 
 <script>
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('/web/sw.js').catch(()=>{}) }
    async function verifyAadhaar() {
      const zipFile = document.getElementById('zipFile').files[0];
      const shareCode = document.getElementById('shareCode').value;
      const resultsDiv = document.getElementById('results');
      const verifyBtn = document.getElementById('verifyBtn');
      
      resultsDiv.innerHTML = '';
      if (!zipFile){ showError('Please select a ZIP file'); return }
      if (!/^\d{4}$/.test(shareCode)){ showError('Please enter a valid 4-digit share code'); return }
      
      verifyBtn.disabled = true;
      verifyBtn.textContent = 'üîÑ Processing...';
      
      try {
        const reader = new zip.ZipReader(new zip.BlobReader(zipFile), { password: shareCode });
        const entries = await reader.getEntries();
        if (!entries.length) throw new Error('Empty ZIP');
        
        let xmlEntry = null; let sigEntry = null;
        for (const e of entries){
          const n = (e.filename||'').toLowerCase();
          if (!xmlEntry && n.endsWith('.xml')) xmlEntry = e;
          if (!sigEntry && (n.endsWith('.p7b') || n.endsWith('.p7s') || n.includes('sign'))) sigEntry = e;
        }
        if (!xmlEntry) throw new Error('No XML file found in ZIP');
        const xmlContent = await xmlEntry.getData(new zip.TextWriter());
        await reader.close();
        
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlContent, 'text/xml');
        const parserError = xmlDoc.querySelector('parsererror');
        if (parserError) throw new Error('Invalid XML format');
        const aadhaarData = extractAadhaarData(xmlDoc);
        showSuccess(aadhaarData, xmlContent, Boolean(sigEntry));
      } catch (error) {
        console.error('Verification error:', error);
        const msg = (''+error.message||'').toLowerCase();
        if (msg.includes('password') || msg.includes('aes')) showError('Invalid share code or encrypted ZIP not supported');
        else showError(`Verification failed: ${error.message}`);
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'üîç Verify & Extract';
      }
    }
    
    function extractAadhaarData(xmlDoc) {
      // Extract data from Aadhaar Offline XML
      // The structure varies but typically has UidData or similar root element
      const root = xmlDoc.documentElement;
      const data = {};
      
      // Try different possible attribute names and structures
      const possibleFields = {
        'name': ['name', 'n'],
        'uid': ['uid', 'aadhaar_number'],
        'gender': ['gender', 'g'],
        'dob': ['dob', 'date_of_birth'],
        'referenceId': ['referenceId', 'ref_id', 'reference_id']
      };
      
      // Extract from root attributes first
      for (const [field, possibleNames] of Object.entries(possibleFields)) {
        for (const attrName of possibleNames) {
          const value = root.getAttribute(attrName);
          if (value) {
            data[field] = value;
            break;
          }
        }
      }
      
      // Also try to find nested elements
      const elements = root.querySelectorAll('*');
      elements.forEach(el => {
        const tagName = el.tagName.toLowerCase();
        if (tagName.includes('poi') || tagName.includes('personalinfo')) {
          // Personal info section
          data.name = data.name || el.getAttribute('name') || el.getAttribute('n');
          data.dob = data.dob || el.getAttribute('dob');
          data.gender = data.gender || el.getAttribute('gender') || el.getAttribute('g');
        }
      });
      
      return data;
    }
    
    function showSuccess(data, xmlContent, hasSignature) {
      const resultsDiv = document.getElementById('results');
      
      let html = '<div class="result">';
      html += '<h3>‚úÖ ZIP Decrypted</h3>';
      html += '<p>Aadhaar Offline ZIP extracted locally.</p>';
      
      html += `<div class="field"><strong>Signature File:</strong> ${hasSignature? 'Found (.p7b/.p7s)' : 'Not found'}</div>`;
      html += '<div class="field"><strong>Signature verification:</strong> Per Android app (on-device PKCS#7 with UIDAI trust)</div>';
      
      if (Object.keys(data).length > 0) {
        html += '<h4>Extracted Data:</h4>';
        for (const [key, value] of Object.entries(data)) {
          if (value) html += `<div class="field"><strong>${key.toUpperCase()}:</strong> ${value}</div>`;
        }
      } else {
        html += '<p><em>No standard fields found. Raw XML structure may vary.</em></p>';
      }
      
      html += '<details style="margin-top:1rem;">';
      html += '<summary style="cursor:pointer;font-weight:600;">üìÑ View Raw XML</summary>';
      html += `<pre>${escapeHtml(xmlContent.substring(0, 2000))}${xmlContent.length > 2000 ? '...\n[truncated]' : ''}</pre>`;
      html += '</details>';
      
      html += '</div>';
      
      resultsDiv.innerHTML = html;
    }
    
    function showError(message) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="error"><h3>‚ùå Error</h3><p>${message}</p></div>`;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Auto-focus on share code when file is selected
    document.getElementById('zipFile').addEventListener('change', function() {
      if (this.files.length > 0) {
        document.getElementById('shareCode').focus();
      }
    });
    
    // Allow Enter key to trigger verification
    document.getElementById('shareCode').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verifyAadhaar();
      }
    });
  </script>
</body>
</html>